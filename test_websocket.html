<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket - Remote Players</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>üéÆ Test WebSocket - Remote Players</h1>
    
    <div class="container">
        <h3>Connexion WebSocket</h3>
        <div id="status" class="status disconnected">D√©connect√©</div>
        <button onclick="connect()">Se connecter</button>
        <button onclick="disconnect()">Se d√©connecter</button>
    </div>

    <div class="container">
        <h3>Test des Parties</h3>
        <div style="margin-bottom: 10px;">
            <label for="gameId" style="display: block; margin-bottom: 5px; font-weight: bold;">
                üéÆ ID de la partie (gameId):
            </label>
            <input type="number" id="gameId" placeholder="Ex: 7" value="1" style="width: 200px;">
            <small style="display: block; color: #666; margin-top: 3px; margin-bottom: 10px;">
                üí° Le num√©ro unique de la partie. Obtenez-le en cr√©ant une partie via "Test API REST"
            </small>
        </div>
        <div style="margin-bottom: 10px;">
            <label for="userId" style="display: block; margin-bottom: 5px; font-weight: bold;">
                üë§ ID utilisateur (userId):
            </label>
            <input type="number" id="userId" placeholder="1 ou 2" value="1" style="width: 200px;">
            <small style="display: block; color: #666; margin-top: 3px; margin-bottom: 10px;">
                üí° Votre identifiant de joueur : <strong>1</strong> (nostag) ou <strong>2</strong> (lolo)
            </small>
        </div>
        <br>
        <button onclick="joinGame()">Rejoindre une partie</button>
        <button onclick="sendMove('up')">Mouvement ‚Üë</button>
        <button onclick="sendMove('down')">Mouvement ‚Üì</button>
    </div>

    <div class="container">
        <h3>Test API REST</h3>
        <button onclick="createGame()">Cr√©er une partie</button>
        <button onclick="getWaitingGames()">Parties en attente</button>
        <button onclick="getGameStatus()">√âtat de la partie</button>
    </div>

    <div class="container">
        <h3>Logs</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Effacer les logs</button>
    </div>

    <script>
        let ws = null; // rp store websocket instance
        let currentGameId = 1; // rp remember current game selection
        let currentUserId = 1; // rp remember current user id
        
        // rp: Always use proxy paths (same as real frontend)
        // rp: This ensures all requests go through nginx proxy, not directly to backend
        const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        
        // rp: Detect if file is served via proxy or opened directly
        const isServedViaProxy = window.location.protocol !== 'file:' && 
                                  (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
        
        // rp: Always use proxy paths - if not served via proxy, show warning
        const apiBase = `${window.location.origin}/game`; // rp: always use proxy path /game
        const wsBase = `${wsProtocol}://${window.location.host}/game/ws`; // rp: always use proxy path /game/ws

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.textContent = 'Connect√©';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'D√©connect√©';
                statusDiv.className = 'status disconnected';
            }
        }

        function connect() {
            if (ws) {
                log('‚ö†Ô∏è D√©j√† connect√©');
                return;
            }

            ws = new WebSocket(wsBase); // rp open websocket using computed endpoint
            
            ws.onopen = function() {
                log('‚úÖ Connexion WebSocket √©tablie');
                updateStatus(true);
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                log(`üì® Message re√ßu: ${JSON.stringify(message, null, 2)}`);
            };

            ws.onclose = function() {
                log('‚ùå Connexion WebSocket ferm√©e');
                updateStatus(false);
                ws = null;
            };

            ws.onerror = function(error) {
                log(`üö® Erreur WebSocket: ${error}`);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function joinGame() {
            const gameId = parseInt(document.getElementById('gameId').value);
            const userId = parseInt(document.getElementById('userId').value);
            
            if (!ws) {
                log('‚ùå Pas de connexion WebSocket');
                return;
            }

            const message = {
                type: 'join_game',
                gameId: gameId,
                userId: userId
            };

            ws.send(JSON.stringify(message));
            log(`üì§ Rejoindre partie ${gameId} en tant qu'utilisateur ${userId}`);
            
            currentGameId = gameId;
            currentUserId = userId;
        }

        function sendMove(direction) {
            if (!ws) {
                log('‚ùå Pas de connexion WebSocket');
                return;
            }

            const message = {
                type: 'player_move',
                gameId: currentGameId,
                playerId: currentUserId,
                direction: direction
            };

            ws.send(JSON.stringify(message));
            log(`üì§ Mouvement ${direction} pour joueur ${currentUserId}`);
        }

        async function createGame() {
            try {
                // rp: Check if served via proxy
                if (!isServedViaProxy) {
                    log('‚ö†Ô∏è ATTENTION: Le fichier n\'est pas servi via le proxy nginx');
                    log('‚ö†Ô∏è Acc√©dez au fichier via: https://localhost:8443/test_websocket.html');
                    log('‚ö†Ô∏è Ou copiez-le dans srcs/frontend/build/ et red√©marrez le proxy');
                    return;
                }
                
                log('üì§ Tentative de cr√©ation de partie...');
                log(`üîó URL: ${apiBase}/api/game/create`);
                
                const response = await fetch(`${apiBase}/api/game/create`, { // rp hit create endpoint relative to base
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player1_id: 1
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå R√©ponse HTTP ${response.status}: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                }

                const data = await response.json();
                log(`‚úÖ Cr√©ation partie r√©ussie: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    document.getElementById('gameId').value = data.gameId;
                    log(`üìù ID de partie mis √† jour: ${data.gameId}`);
                }
            } catch (error) {
                log(`üö® Erreur cr√©ation partie: ${error.message || error}`);
                log(`üí° URL tent√©e: ${apiBase}/api/game/create`);
                log(`üí° V√©rifiez que le proxy nginx est d√©marr√© et accessible`);
                log(`üí° V√©rifiez que le backend service-game est d√©marr√©`);
                log(`üí° Acc√©dez au fichier via: https://localhost:8443/test_websocket.html`);
                log(`üí° Ouvrez la console (F12) pour plus de d√©tails`);
                console.error('Erreur compl√®te:', error);
                console.error('URL tent√©e:', `${apiBase}/api/game/create`);
            }
        }

        async function getWaitingGames() {
            try {
                // rp: Check if served via proxy
                if (!isServedViaProxy) {
                    log('‚ö†Ô∏è ATTENTION: Le fichier n\'est pas servi via le proxy nginx');
                    log('‚ö†Ô∏è Acc√©dez au fichier via: https://localhost:8443/test_websocket.html');
                    return;
                }
                
                log('üì§ Tentative de r√©cup√©ration des parties en attente...');
                log(`üîó URL: ${apiBase}/api/games/waiting`);
                
                const response = await fetch(`${apiBase}/api/games/waiting`); // rp call waiting games endpoint
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå R√©ponse HTTP ${response.status}: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                }
                
                const data = await response.json();
                log(`‚úÖ Parties en attente: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                log(`üö® Erreur r√©cup√©ration parties: ${error.message || error}`);
                log(`üí° URL tent√©e: ${apiBase}/api/games/waiting`);
                log(`üí° V√©rifiez que le proxy nginx est d√©marr√© et accessible`);
                log(`üí° V√©rifiez que le backend service-game est d√©marr√©`);
                log(`üí° Ouvrez la console (F12) pour plus de d√©tails`);
                console.error('Erreur compl√®te:', error);
                console.error('URL tent√©e:', `${apiBase}/api/games/waiting`);
            }
        }

        async function getGameStatus() {
            const gameId = document.getElementById('gameId').value;
            try {
                // rp: Check if served via proxy
                if (!isServedViaProxy) {
                    log('‚ö†Ô∏è ATTENTION: Le fichier n\'est pas servi via le proxy nginx');
                    log('‚ö†Ô∏è Acc√©dez au fichier via: https://localhost:8443/test_websocket.html');
                    return;
                }
                
                log(`üì§ Tentative de r√©cup√©ration de l'√©tat de la partie ${gameId}...`);
                log(`üîó URL: ${apiBase}/api/game/${gameId}/status`);
                
                const response = await fetch(`${apiBase}/api/game/${gameId}/status`); // rp fetch status from computed base
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå R√©ponse HTTP ${response.status}: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                }
                
                const data = await response.json();
                log(`‚úÖ √âtat partie ${gameId}: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                log(`üö® Erreur r√©cup√©ration √©tat: ${error.message || error}`);
                log(`üí° URL tent√©e: ${apiBase}/api/game/${gameId}/status`);
                log(`üí° V√©rifiez que le proxy nginx est d√©marr√© et accessible`);
                log(`üí° V√©rifiez que le backend service-game est d√©marr√©`);
                log(`üí° V√©rifiez que la partie ${gameId} existe`);
                log(`üí° Ouvrez la console (F12) pour plus de d√©tails`);
                console.error('Erreur compl√®te:', error);
                console.error('URL tent√©e:', `${apiBase}/api/game/${gameId}/status`);
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Auto-connexion au chargement
        window.onload = function() {
            log('üöÄ Page de test charg√©e'); // rp confirm page load
            log(`üåê Protocole: ${protocol.toUpperCase()}`); // rp show protocol mode
            log(`üåê Host: ${window.location.host || 'N/A'}`); // rp show host
            log(`‚û°Ô∏è Base API: ${apiBase}`); // rp display rest base url
            log(`‚û°Ô∏è WebSocket: ${wsBase}`); // rp display websocket url
            
            // rp: Warn if not served via proxy
            if (!isServedViaProxy) {
                log('‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ATTENTION ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è');
                log('‚ö†Ô∏è Le fichier n\'est PAS servi via le proxy nginx');
                log('‚ö†Ô∏è Les requ√™tes API ne fonctionneront PAS');
                log('‚ö†Ô∏è Pour corriger:');
                log('   1. Copiez test_websocket.html dans srcs/frontend/build/');
                log('   2. Ou acc√©dez-y via: https://localhost:8443/test_websocket.html');
                log('‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è');
            } else {
                log('‚úÖ Fichier servi via le proxy nginx');
                log('üí° Toutes les requ√™tes passent par le proxy (comme le vrai frontend)');
            }
            
            log('üí° Cliquez sur "Se connecter" pour commencer'); // rp instruct user to connect
        };
    </script>
</body>
</html>



